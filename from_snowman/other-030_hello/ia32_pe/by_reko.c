// subject.c
// Generated by decompiling subject.exe
// using Reko decompiler version VERSION

#include "subject.h"

// 00401000: void fn00401000(Register word32 ecx, Register word32 ebx, Register word32 ebp)
void fn00401000(word32 ecx, word32 ebx, word32 ebp)
{
	LPTOP_LEVEL_EXCEPTION_FILTER * esp_155 = fp - 0x3C;
	<anonymous> * eax_11 = globals->ptr403074;
	if (eax_11 != null)
	{
		word32 esp_145;
		word32 ebp_146;
		byte SCZO_148;
		word32 eax_149;
		byte SZO_150;
		byte C_151;
		byte Z_152;
		word32 edx_153;
		eax_11();
		esp_155 = esp_145 - 0x0C;
	}
	*esp_155 = (LPTOP_LEVEL_EXCEPTION_FILTER *) &globals->t401110;
	struct Eq_18 * esp_28 = esp_155 - 0x04;
	esp_28->t0000 = SetUnhandledExceptionFilter(*esp_155);
	word32 ecx_30 = fn00401514(ecx, ebx);
	fn004015F4();
	esp_28->ptr0010 = fp - 0x14;
	esp_28->dw000C = globals->dw402000;
	esp_28->ptr0008 = fp - 0x10;
	esp_28->dw0004 = 0x00405004;
	esp_28->t0000 = (Eq_14) &globals->dw405000;
	struct Eq_63 * esp_40;
	word32 ebp_41;
	word32 ebx_42;
	byte SCZO_43;
	word32 eax_44;
	byte SZO_45;
	byte C_46;
	byte Z_47;
	word32 edx_48;
	word32 ecx_49;
	_getmainargs();
	byte * eax_50 = globals->ptr405034;
	if (eax_50 != null)
	{
		globals->ptr402004 = eax_50;
		esp_40->ptr0004 = eax_50;
		word32 eax_100 = iob->dw0010;
		esp_40->dw0000 = eax_100;
		struct Eq_104 * esp_102;
		word32 ebp_103;
		struct Eq_106 * ebx_104;
		byte SCZO_105;
		word32 eax_106;
		byte SZO_107;
		byte C_108;
		byte Z_109;
		word32 edx_110;
		word32 ecx_111;
		setmode();
		esp_102->ptr0004 = globals->ptr405034;
		word32 eax_114 = ebx_104->dw0030;
		esp_102->dw0000 = eax_114;
		struct Eq_128 * esp_116;
		word32 ebp_117;
		struct Eq_130 * ebx_118;
		byte SCZO_119;
		word32 eax_120;
		byte SZO_121;
		byte C_122;
		byte Z_123;
		word32 edx_124;
		word32 ecx_125;
		setmode();
		esp_116->ptr0004 = globals->ptr405034;
		word32 eax_128 = ebx_118->dw0050;
		esp_116->dw0000 = eax_128;
		word32 esp_130;
		word32 ebp_131;
		word32 ebx_132;
		byte SCZO_133;
		word32 eax_134;
		byte SZO_135;
		byte C_136;
		byte Z_137;
		word32 edx_138;
		word32 ecx_139;
		setmode();
	}
	ptr32 esp_54;
	word32 ebp_55;
	word32 ebx_56;
	byte SCZO_57;
	byte ** eax_58;
	byte SZO_59;
	byte C_60;
	byte Z_61;
	word32 edx_62;
	Eq_173 ecx_63;
	_p__fmode();
	byte * edx_64 = globals->ptr402004;
	*eax_58 = (byte **) edx_64;
	word32 edx_66;
	fn0040172C(ecx_63, edx_64, ebp_55, out edx_66);
	__align(esp_54);
	word32 eax_68 = fn00401974();
	struct Eq_199 * esp_69;
	word32 ebp_70;
	word32 ebx_71;
	byte SCZO_72;
	word32 * eax_73;
	byte SZO_74;
	byte C_75;
	byte Z_76;
	word32 edx_77;
	word32 ecx_78;
	_p__environ();
	esp_69->dw0008 = *eax_73;
	esp_69->dw0004 = globals->dw405004;
	word32 eax_83 = globals->dw405000;
	esp_69->dw0000 = eax_83;
	fn0040138C(ebp);
	UINT * esp_86;
	word32 ebp_87;
	word32 ebx_88;
	byte SCZO_89;
	word32 eax_90;
	byte SZO_91;
	byte C_92;
	byte Z_93;
	word32 edx_94;
	word32 ecx_95;
	cexit();
	*esp_86 = (uint32) 0x00;
	ExitProcess(*esp_86);
}

// 0040126C: Register Eq_255 Win32CrtStartup()
DWORD Win32CrtStartup()
{
	word32 esp_9;
	word32 ebp_10;
	byte SCZO_11;
	word32 eax_12;
	word32 ecx_13;
	word32 ebx_14;
	_set_app_type();
	fn00401000(ecx_13, ebx_14, ebp_10);
	word32 esp_21;
	word32 ebp_22;
	byte SCZO_23;
	word32 eax_24;
	word32 ecx_25;
	word32 ebx_26;
	_set_app_type();
	fn00401000(ecx_25, ebx_26, ebp_22);
	return fn0040129C();
}

// 0040129C: Register int32 fn0040129C()
int32 fn0040129C()
{
	return atexit(*esp_11);
}

// 0040138C: void fn0040138C(Stack word32 dwArg00)
void fn0040138C(word32 dwArg00)
{
	__align(fp);
	word32 eax_15 = fn00401974();
	word32 esp_18;
	word32 ecx_19;
	word32 ebp_20;
	byte SCZO_21;
	word32 eax_22;
	ZStlsISt11char_traitsIcEERSt13basic_ostreamIcT_ES5_PKc();
	word32 esp_25;
	word32 ecx_26;
	word32 ebp_27;
	byte SCZO_28;
	word32 eax_29;
	ZNSolsEPFRSoS_E();
}

// 00401514: Register word32 fn00401514(Register word32 ecx, Register word32 ebx)
word32 fn00401514(word32 ecx, word32 ebx)
{
	byte dh_17 = SLICE(SCZDOP, byte, 8);
	if (((SCZDOP ^ 0x00200000 ^ SCZDOP) & 0x00200000) != 0x00)
	{
		word32 eax_54;
		word32 ebx_55;
		word32 edx_57;
		__cpuid(0x00, ecx, &eax_54, &ebx_55, &ecx, &edx_57);
		if (eax_54 != 0x00)
		{
			word32 eax_62;
			word32 ebx_63;
			word32 ecx_64;
			ui32 edx_65;
			__cpuid(0x01, ecx, &eax_62, &ebx_63, &ecx_64, &edx_65);
			if ((dh_17 & 0x01) != 0x00)
				globals->dw405038 = globals->dw405038 | 0x01;
			if ((dh_17 & 0x80) != 0x00)
				globals->dw405038 = globals->dw405038 | 0x02;
			if ((edx_65 & 0x00800000) != 0x00)
				globals->dw405038 = globals->dw405038 | 0x04;
			if ((edx_65 & 0x01000000) != 0x00)
				globals->dw405038 = globals->dw405038 | 0x08;
			if ((edx_65 & 0x02000000) != 0x00)
				globals->dw405038 = globals->dw405038 | 0x10;
			if ((edx_65 & 0x04000000) != 0x00)
				globals->dw405038 = globals->dw405038 | 0x20;
			if ((cl & 0x01) != 0x00)
				globals->dw405038 = globals->dw405038 | 0x40;
			word32 ecx_91 = DPB(ecx_64, ch & 0x20, 8);
			if ((ch & 0x20) != 0x00)
				globals->dw405038 = globals->dw405038 | 0x80;
			up32 eax_98;
			word32 ebx_99;
			word32 edx_101;
			__cpuid(0x80000000, ecx_91, &eax_98, &ebx_99, &ecx, &edx_101);
			if (eax_98 > 0x80000000)
			{
				word32 eax_105;
				word32 ebx_106;
				int32 edx_108;
				__cpuid(0x80000001, ecx, &eax_105, &ebx_106, &ecx, &edx_108);
				if (edx_108 < 0x00)
					globals->dw405038 = globals->dw405038 | 0x0100;
				if ((edx_108 & 0x40000000) != 0x00)
					globals->dw405038 = globals->dw405038 | 0x0200;
			}
		}
	}
	return ecx;
}

// 004015F4: void fn004015F4()
void fn004015F4()
{
	__fninit();
}

// 004015FC: Register (ptr code) fn004015FC(Register Eq_173 ecx, Register (ptr byte) edx, Stack word32 dwArg04, Register out Eq_471 ecxOut, Register out ptr32 edxOut, Register out (ptr Eq_473) ebxOut, Register out ptr32 ebpOut, Register out ptr32 esiOut)
code * fn004015FC(Eq_173 ecx, byte * edx, word32 dwArg04, Eq_471 & ecxOut, ptr32 & edxOut, Eq_473 * & ebxOut, ptr32 & ebpOut, ptr32 & esiOut)
{
	word32 esp_21;
	word32 ebp_22;
	word32 esi_23;
	word32 ebx_24;
	byte SCZO_25;
	word32 eax_26;
	word32 ecx_27;
	word32 edx_28;
	msvcrt.dll!fwrite();
	word32 esp_34;
	word32 ebp_35;
	word32 esi_36;
	word32 ebx_37;
	byte SCZO_38;
	Eq_190 eax_39;
	Eq_173 ecx_40;
	byte * edx_41;
	msvcrt.dll!vfprintf();
	abort();
	word32 edx_42;
	return fn00401648(eax_39, ecx_40, edx_41, out edx_42);
}

// 00401648: Register Eq_190 fn00401648(Register Eq_190 eax, Register Eq_173 ecx, Register (ptr byte) edx, Register out ptr32 edxOut)
Eq_190 fn00401648(Eq_190 eax, Eq_173 ecx, byte * edx, ptr32 & edxOut)
{
	*edxOut = edx;
	byte * esi_105 = edx;
	if (ecx == 0x00)
		return eax;
	Eq_173 ecx_104 = ecx;
	if (VirtualQuery(eax, fp - 0x3C, 0x1C) == 0x00)
	{
		Eq_173 ecx_177;
		byte * edx_178;
		word32 ebx_179;
		word32 ebp_180;
		word32 esi_181;
		fn004015FC(ecx, edx, 0x00403090, out ecx_177, out edx_178, out ebx_179, out ebp_180, out esi_181);
		word32 edx_184;
		return fn0040172C(ecx_177, edx_178, ebp_180, out edx_184);
	}
	else if (dwLoc28 == 0x40 || dwLoc28 == 0x04)
	{
		Eq_190 edi_103 = eax;
		while (ecx_104 != 0x00)
		{
			*edi_103 = *esi_105;
			esi_105 = esi_105 + 0x01;
			edi_103 = edi_103 + 0x01;
			ecx_104 = ecx_104 - 0x01;
		}
		return dwLoc28;
	}
	else
	{
		VirtualProtect(dwLoc3C, dwLoc30, 0x40, fp - 0x20);
		eax = dwLoc28;
		Eq_173 ecx_139 = ecx;
		Eq_190 edi_140 = eax;
		while (ecx_139 != 0x00)
		{
			*edi_140 = *esi_105;
			esi_105 = esi_105 + 0x01;
			edi_140 = edi_140 + 0x01;
			ecx_139 = ecx_139 - 0x01;
		}
		word32 edx_151;
		*edxOut = fp - 0x20;
		if (dwLoc28 == 0x40 || dwLoc28 == 0x04)
			return eax;
		return VirtualProtect(dwLoc3C, dwLoc30, dwLoc20, fp - 0x20);
	}
}

// 0040172C: Register (ptr code) fn0040172C(Register Eq_173 ecx, Register (ptr byte) edx, Register word32 ebp, Register out ptr32 edxOut)
code * fn0040172C(Eq_173 ecx, byte * edx, word32 ebp, ptr32 & edxOut)
{
}

// 00401974: Register word32 fn00401974()
word32 fn00401974()
{
	word32 ecx_8 = globals->dw405040;
	if (ecx_8 != 0x00)
		return eax;
	globals->dw405040 = 0x01;
	word32 * esp_41 = fp - 0x1C;
	ui32 ebx_42 = globals->dw401C60;
	if (ebx_42 == ~0x00)
	{
		ebx_42 = 0x00;
		while (true)
		{
			ui32 eax_82 = ebx_42 + 0x01;
			if ((&globals->dw401C60)[eax_82] == 0x00)
				break;
			ebx_42 = eax_82;
		}
	}
	if (ebx_42 != 0x00)
	{
		do
		{
			word32 ebp_66;
			byte SCZO_67;
			word32 ecx_68;
			byte SZO_69;
			byte C_70;
			byte Z_71;
			word32 ebx_72;
			word32 eax_73;
			word32 edx_74;
			(&globals->dw401C60)[ebx_42]();
		} while (ebx_72 != 0x01);
	}
	*esp_41 = 0x004018F8;
	return fn0040129C();
}

