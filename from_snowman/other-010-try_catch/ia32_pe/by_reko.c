// subject.c
// Generated by decompiling subject.exe
// using Reko decompiler version VERSION

#include "subject.h"

// 00401005: Register word32 fn00401005()
word32 fn00401005()
{
	fs->ptr0000 = fp - 0x10;
	word32 esp_44;
	word32 ebp_45;
	word32 eax_46;
	struct Eq_12 * fs_47;
	byte SCZO_48;
	word32 ebx_49;
	word32 esi_50;
	word32 edi_51;
	byte SZO_52;
	bool C_53;
	CxxThrowException();
	return ebp_45;
}

// 004013F6: Register Eq_21 Win32CrtStartup()
Eq_21 Win32CrtStartup()
{
	fn004019A0();
	ptr32 esp_220 = fp - 0x08;
	word32 * ebp_10 = fn004018C0(ebx, esi, edi, dwLoc0C, 4215112, 0x10);
	if (globals->dw4064E4 == 0x00)
	{
		HeapSetInformation(null, SLICE(0x00, HEAP_INFORMATION_CLASS, 32), (void *) 0x01, 0x00);
		esp_220 = fp - 0x0C;
	}
	*(ebp_10 - 0x04) = 0x00;
	Eq_21 esi_28 = fs->ptr0018->t0004;
	*(ebp_10 - 0x1C) = 0x00;
	while (true)
	{
		union Eq_21 * esp_32 = esp_220 - 0x04;
		*esp_32 = 0x00;
		*(esp_32 - 0x04) = (union Eq_21 *) esi_28;
		*(esp_32 - 0x08) = 0x004064CC;
		Eq_21 eax_38 = InterlockedCompareExchange(*(esp_32 - 0x08), *(esp_32 - 0x04), *esp_32);
		if (eax_38 == 0x00)
			break;
		if (eax_38 == esi_28)
		{
			*(ebp_10 - 0x1C) = 0x01;
			break;
		}
		*esp_32 = 1000;
		Sleep(*esp_32);
	}
	if (globals->dw4064BC == 0x01)
	{
		*esp_32 = 0x1F;
		_amsg_exit(*esp_32);
	}
	Eq_21 eax_125;
	if (globals->dw4064BC == 0x00)
	{
		globals->dw4064BC = 0x01;
		*esp_32 = 4212248;
		*(esp_32 - 0x04) = 0x0040430C;
		if (_initterm_e(*(esp_32 - 0x04), *esp_32) != 0x00)
		{
			*(ebp_10 - 0x04) = ~0x01;
			eax_125.u0 = 0xFF;
			goto l004012EF;
		}
	}
	else
		globals->dw406184 = 0x01;
	if (globals->dw4064BC == 0x01)
	{
		PVFV ** esp_170 = esp_220 - 0x04;
		*esp_170 = (PVFV **) &globals->t404208;
		*(esp_170 - 0x04) = 0x00404000;
		_initterm(*(esp_170 - 0x04), *esp_170);
		globals->dw4064BC = 0x02;
	}
	if (*(ebp_10 - 0x1C) == 0x00)
	{
		union Eq_21 * esp_164 = esp_220 - 0x04;
		*esp_164 = 0x00;
		*(esp_164 - 0x04) = 0x004064CC;
		InterlockedExchange(*(esp_164 - 0x04), *esp_164);
	}
	ptr32 esp_142 = esp_220;
	if (globals->ptr4064E8 != null)
	{
		word32 * esp_138 = esp_220 - 0x04;
		*esp_138 = 0x004064E8;
		word32 eax_140 = fn004017F0(dwArg00);
		esp_142 = esp_138 + 0x01;
		if (eax_140 != 0x00)
		{
			*esp_138 = 0x00;
			*(esp_138 - 0x04) = 0x02;
			*(esp_138 - 0x08) = 0x00;
			word32 ebx_153;
			byte SZO_154;
			bool C_155;
			byte SCZO_156;
			bool Z_157;
			word32 eax_158;
			word32 ebp_159;
			struct Eq_358 * fs_160;
			word32 esi_161;
			word32 edi_162;
			word32 ecx_163;
			globals->ptr4064E8();
		}
	}
	Eq_279 eax_92 = globals->t40616C;
	*_initenv = (union Eq_279 *) eax_92;
	union Eq_279 * esp_96 = esp_142 - 0x04;
	*esp_96 = (union Eq_279 *) globals->t40616C;
	*(esp_96 - 0x04) = globals->dw406170;
	*(esp_96 - 0x08) = globals->dw406168;
	ebp_10 = fn00401005();
	globals->t406180.u0 = 0x0040106F;
	if (globals->dw406174 == 0x00)
	{
		*esp_96 = 0x0040106F;
		exit(*esp_96);
	}
	if (globals->dw406184 == 0x00)
	{
		word32 esp_126;
		word32 ebx_127;
		byte SZO_128;
		bool C_129;
		byte SCZO_130;
		bool Z_131;
		word32 eax_132;
		struct Eq_394 * fs_134;
		word32 esi_135;
		word32 edi_136;
		word32 ecx_137;
		cexit();
	}
	*(ebp_10 - 0x04) = ~0x01;
	eax_125 = globals->t406180;
l004012EF:
	fn00401905(ebp_10, 0x10, dwArg00, dwArg04, dwArg08, dwArg0C);
	return eax_125;
}

// 00401760: Register word32 fn00401760(Stack (ptr32 Eq_401) dwArg04)
word32 fn00401760(Eq_401 * dwArg04)
{
	if (dwArg04->w0000 != 23117)
		return 0x00;
	struct Eq_407 * eax_39 = dwArg04 + dwArg04->dw003C / 0x0040;
	if (eax_39->dw0000 != 0x4550)
		return 0x00;
	return (word32) (eax_39->w0018 == 0x010B);
}

// 004017A0: Register (ptr32 Eq_424) fn004017A0(Stack (ptr32 Eq_425) dwArg04, Stack uint32 dwArg08)
Eq_424 * fn004017A0(Eq_425 * dwArg04, uint32 dwArg08)
{
	struct Eq_427 * ecx_12 = dwArg04 + dwArg04->dw003C / 0x0040;
	up32 esi_20 = (word32) ecx_12->w0006;
	up32 edx_21 = 0x00;
	struct Eq_424 * eax_24 = ecx_12 + ((word32) ecx_12->w0014 + 0x18) / 22;
	if (esi_20 != 0x00)
	{
		do
		{
			uint32 ecx_56 = eax_24->dw000C;
			if (dwArg08 >= ecx_56 && dwArg08 < eax_24->dw0008 + ecx_56)
				return eax_24;
			++edx_21;
			++eax_24;
		} while (edx_21 < esi_20);
	}
	eax_24 = null;
	return eax_24;
}

// 004017F0: Register ui32 fn004017F0(Stack ui32 dwArg04)
ui32 fn004017F0(ui32 dwArg04)
{
	ptr32 eax_16 = fs->ptr0000;
	fs->ptr0000 = fp - 0x14;
	if (fn00401760(&globals->t400000) != 0x00)
	{
		struct Eq_484 * eax_92 = fn004017A0(&globals->t400000, dwArg04 - 0x00400000);
		if (eax_92 != null)
		{
			uint32 eax_99 = ~(eax_92->dw0024 >> 0x1F);
			fs->ptr0000 = eax_16;
			return eax_99 & 0x01;
		}
	}
	fs->ptr0000 = eax_16;
	return 0x00;
}

// 004018C0: Register ptr32 fn004018C0(Register word32 ebx, Register word32 esi, Register word32 edi, Stack word32 dwArg00, Stack word32 dwArg04, Stack ui32 dwArg08)
ptr32 fn004018C0(word32 ebx, word32 esi, word32 edi, word32 dwArg00, word32 dwArg04, ui32 dwArg08)
{
	ptr32 esp_14 = fp - 0x08 - dwArg08;
	*(esp_14 - 0x04) = ebx;
	*(esp_14 - 0x08) = esi;
	*(esp_14 - 0x0C) = edi;
	*(esp_14 - 0x0010) = globals->dw406020 ^ fp + 0x08;
	*(esp_14 - 0x0014) = dwArg00;
	fs->ptr0000 = fp - 0x08;
	return fp + 0x08;
}

// 00401905: void fn00401905(Register (ptr32 word32) ebp, Stack word32 dwArg00, Stack ui32 dwArg04, Stack word32 dwArg08, Stack word32 dwArg0C, Stack word32 dwArg10)
void fn00401905(word32 * ebp, word32 dwArg00, ui32 dwArg04, word32 dwArg08, word32 dwArg0C, word32 dwArg10)
{
	fs->dw0000 = *(ebp - 0x10);
	*ebp = dwArg00;
}

// 004019A0: void fn004019A0()
void fn004019A0()
{
	ui32 eax_10 = globals->dw406020;
	if (eax_10 != 0xBB40E64E && (eax_10 & 0xFFFF0000) != 0x00)
		globals->dw406024 = ~eax_10;
	else
	{
		GetSystemTimeAsFileTime(fp - 0x0C);
		ui32 esi_59 = dwLoc08 & 0x00 ^ dwLoc0C & 0x00 ^ GetCurrentProcessId() ^ GetCurrentThreadId() ^ GetTickCount();
		QueryPerformanceCounter(fp - 0x14);
		ui32 esi_69 = esi_59 ^ (dwLoc10 ^ dwLoc14);
		if (esi_69 == 0xBB40E64E)
			esi_69 = ~0x44BF19B0;
		else if ((esi_69 & 0xFFFF0000) == 0x00)
			esi_69 |= (esi_69 | 0x4711) << 0x10;
		globals->dw406020 = esi_69;
		globals->dw406024 = ~esi_69;
	}
}

