// subject.c
// Generated by decompiling subject.exe
// using Reko decompiler version VERSION

#include "subject.h"

// 00401000: Register byte fn00401000(Stack Eq_3 dwArg04)
byte fn00401000(LPCSTR dwArg04)
{
	byte al_38;
	Eq_5 eax_28 = CreateFileA(dwArg04, 0x40000000, 0x07, null, 0x02, 0x80, null);
	if (eax_28 == (void *) ~0x00)
		al_38 = 0x00;
	else
	{
		WriteFile(eax_28, &globals->v403010, globals->t403008, fp - 0x08, null);
		CloseHandle(eax_28);
		al_38 = 0x01;
	}
	return al_38;
}

// 0040104F: void fn0040104F()
void fn0040104F()
{
	if (OpenProcessToken(GetCurrentProcess(), 0x000200E0, fp - 0x08) != 0x00 && LookupPrivilegeValueA(null, &globals->t402060, fp - 0x10) != 0x00)
	{
		AdjustTokenPrivileges(null, 0x00, fp - 0x20, 0x10, null, null);
		GetLastError();
	}
}

// 004010C7: void fn004010C7()
void fn004010C7()
{
	if (GetSystemDirectoryA(fp - 0x0240, 0x0104) == 0x00 || SetCurrentDirectoryA(fp - 0x0240) == 0x00)
		return;
	Eq_5 eax_97 = OpenEventA(0x00100002, 0x00, &globals->t402090);
	if (eax_97 != null)
	{
		SetEvent(eax_97);
		CloseHandle(eax_97);
	}
	GetFullPathNameA(&globals->t402080, 0x0104, fp - 0x0138, fp - 0x18);
	byte bLoc05_113 = 0x00;
	Eq_137 eax_122 = OpenSCManagerA(null, null, 0x40000000);
	if (eax_122 == null)
	{
l00401210:
		if (eax_97 == null && bLoc05_113 != 0x00)
		{
			fn0040104F();
			if (0x00 != 0x00)
				ExitWindowsEx(0x12, 0x00);
		}
		return;
	}
	Eq_137 eax_204 = CreateServiceA(eax_122, &globals->t402074, &globals->t402074, 0x000F01FF, 0x01, 0x02, 0x01, fp - 0x0138, null, null, null, null, null);
	Eq_137 dwLoc0C_208 = eax_204;
	if (eax_204 == null)
	{
		if (GetLastError() == 0x0431)
		{
			Eq_137 eax_323 = OpenServiceA(eax_122, &globals->t402074, 0x000F01FF);
			dwLoc0C_208 = eax_323;
			if (eax_323 == null)
				goto l00401207;
			ControlService(eax_323, 0x01, fp - 0x34);
			ChangeServiceConfigA(eax_323, 0x01, 0x02, 0x01, fp - 0x0138, null, null, null, null, null, &globals->t402074);
			bLoc05_113 = 0x01;
		}
		if (dwLoc0C_208 == null)
			goto l00401207;
		if (fn00401000(fp - 0x0138) == 0x00)
		{
l004011F9:
			if (dwLoc0C_208 != null)
				CloseServiceHandle(dwLoc0C_208);
l00401207:
			CloseServiceHandle(eax_122);
			goto l00401210;
		}
	}
	StartServiceA(dwLoc0C_208, 0x00, null);
	goto l004011F9;
}

