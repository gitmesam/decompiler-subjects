// subject.c
// Generated by decompiling subject.exe
// using Reko decompiler version VERSION

#include "subject.h"

// 00401000: Register Eq_2 Win32CrtStartup()
DWORD Win32CrtStartup()
{
	struct Eq_3 * ebp_15 = null;
	struct Eq_3 * dwLoc08_17 = (struct Eq_3 *) 0x25;
	Eq_2 eax_22 = AddUsersToEncryptedFile(null, null);
	if (eax_22 == 0x00)
		return eax_22;
	if (AreAllAccessesGranted(~0x00, ~0x00) == 0x00)
		dwLoc08_17 = (struct Eq_3 *) 0x2B;
	VirtualProtect(&globals->v401000, 0x3000, 0x40, fp - 0x0C);
	struct Eq_39 * eax_50 = null;
	do
	{
		if (ebp_15 == dwLoc08_17)
			ebp_15 = null;
		eax_50[4199880] = (struct Eq_39) (ebp_15[0x00404000] ^ eax_50[4199880] ^ 202);
		eax_50 = eax_50 + 0x01;
		ebp_15 = ebp_15 + 0x01;
	} while (eax_50 < (struct Eq_39 *) 0x1440);
	up32 ecx_263 = 0x00;
	struct Eq_64 * edi_259 = &globals->t4028C8;
	Eq_66 ebp_111 = (struct HINSTANCE__ *) 0xF0401348;
	up32 dwLoc04_256 = 0x00;
	if (true)
	{
		do
		{
			Eq_81 eax_264 = edi_259->t0004;
			edx = edx * 0x09;
			word16 * esi_271 = (char *) &edi_259->t0004 + 0x04;
			if (eax_264 - 0x08 >> 0x01 > 0x00)
			{
				uint32 dwLoc08_286 = eax_264 - 0x08 >> 0x01;
				do
				{
					cui16 dx_294 = *esi_271;
					edx = DPB(edx, dx_294 & 0xF000, 0);
					if ((dx_294 & 0xF000) == 0x3000)
					{
						struct Eq_191 * eax_313 = ((word32) *esi_271 & 0x0FFF) + edi_259->dw0000;
						eax_313->dw401348 = eax_313->dw401348 + 0xF0401348;
						edx = edx + esi_271;
					}
					uint32 v20_303 = dwLoc08_286 - 0x01;
					esi_271 = esi_271 + 0x01;
					dwLoc08_286 = v20_303;
				} while (v20_303 != 0x00);
				ecx_263 = dwLoc04_256;
			}
			ecx_263 = (word32) edi_259->t0004 + ecx_263;
			dwLoc04_256 = ecx_263;
			edi_259 = edi_259 + Mem77[edi_259 + 0x04:word32];
		} while (ecx_263 < 228);
	}
	struct Eq_71 * esi_108 = &globals->t4020B4;
	struct Eq_71 * dwLoc08_109 = &globals->t4020B4;
	if (globals->dw4020C4 != 0x00)
	{
		do
		{
			word32 ecx_142 = esi_108->dw000C;
			Eq_66 eax_147 = LoadLibraryA(ecx_142 + 0x00401348);
			Eq_146 ecx_143 = ecx_142 + 0x00401348;
			ebp_111 = eax_147;
			if (eax_147 != null)
			{
				struct Eq_157 * edi_171 = esi_108->dw0000;
				if (edi_171 == null)
					edi_171 = esi_108->dw0010;
				Eq_163 eax_177 = edi_171->t401348;
				union Eq_167 * edi_178 = &edi_171->t401348;
				word32 * esi_179 = esi_108->dw0010 + 0x00401348;
				bool S_182 = (bool) cond(eax_177);
				if (eax_177 != 0x00)
				{
					do
					{
						Eq_221 eax_223;
						if (!S_182)
						{
							Eq_142 edx_236 = (word32) *edi_178;
							eax_223 = GetProcAddress(eax_147, edx_236);
							edx = edx_236 + ecx_143;
						}
						else
						{
							ecx_143 = ecx_143 * 0x05;
							eax_223 = GetProcAddress(eax_147, (word32) eax_177 + 4199242);
						}
						*esi_179 = (word32) eax_223;
						edi_178 = (union Eq_167 *) ((char *) edi_178 + 0x04);
						eax_177 = *edi_178;
						esi_179 = esi_179 + 0x01;
						S_182 = (bool) cond(eax_177);
					} while (eax_177 != 0x00);
				}
				esi_108 = dwLoc08_109;
			}
			esi_108 = esi_108 + 0x01;
			dwLoc08_109 = esi_108;
		} while (esi_108->dw0010 != 0x00);
	}
	fn00401DA8(&globals->w401DA8, edx, 0x13, ebp_111, esi_108, psegLoc24, dwLoc22);
	*(fp - 0x24) = 0x00;
	ExitProcess(*(fp - 0x24));
}

// 00401DA8: void fn00401DA8(Register (ptr32 word16) ecx, Register Eq_100 edx, Register byte bh, Register Eq_66 ebp, Register (ptr32 Eq_71) esi, Stack (ptr16 Eq_114) psegArg00, Stack word32 dwArg02)
void fn00401DA8(word16 * ecx, Eq_100 edx, byte bh, HMODULE ebp, Eq_71 * esi, Eq_114 * psegArg00, word32 dwArg02)
{
	word32 eax_10 = esi->dw0000;
	__arpl(*ecx, DPB(bx, ~0x42, 0), &*ecx);
	Eq_273 v15_20 = *((char *) ebp - 1019915871);
	*((char *) ebp - 1019915871) = (Eq_66) SLICE(eax_10, byte, 8);
	ui32 eax_23 = DPB(eax_10, v15_20, 8);
	*((word32) edx + (eax_23 * 0x02 + 0x01)) = *((word32) edx + (eax_23 * 0x02 + 0x01)) - ecx;
	byte al_41;
	byte ah_42;
	__aaa((byte) ((word32) edx + 0x01), SLICE((word32) edx + 0x01, byte, 8), &al_41, &ah_42);
}

