// subject.c
// Generated by decompiling subject.exe
// using Reko decompiler version VERSION

#include "subject.h"

// 003E1000: Register word32 fn003E1000(Stack (ptr Eq_3) dwArg04)
word32 fn003E1000(Eq_3 * dwArg04)
{
	return dwArg04 + Mem0[dwArg04 + 0x3C:word32];
}

// 003E101F: void fn003E101F(Stack (ptr Eq_3) dwArg04, Stack Eq_9 dwArg08, Stack Eq_10 dwArg0C)
void fn003E101F(Eq_3 * dwArg04, Eq_9 dwArg08, SIZE_T dwArg0C)
{
	fn003E1942(dwArg08, dwArg04, dwArg0C);
	VirtualProtect(dwArg08, dwArg0C, 0x02, fp - 0x08);
}

// 003E10B0: Register Eq_28 fn003E10B0(Stack Eq_9 dwArg04, Stack (ptr Eq_3) dwArg08, Stack Eq_9 dwArg0C)
FARPROC fn003E10B0(Eq_9 dwArg04, Eq_3 * dwArg08, Eq_9 dwArg0C)
{
	Eq_28 eax_43;
	Eq_28 eax_21 = GetProcAddress(dwArg04, dwArg0C);
	if (fn003E1A30(dwArg08, &globals->b3E2030) == 0x00)
	{
		if (fn003E19AF(0x003E2030, dwArg0C, &globals->b3E2040) == 0x00)
		{
			globals->t3E8810 = eax_21;
			eax_43 = (Eq_28) &globals->t3E1050;
			return eax_43;
		}
		if (fn003E19AF(0x003E2040, dwArg0C, &globals->b3E2054) == 0x00)
		{
			globals->t3E8814 = eax_21;
			eax_43 = (Eq_28) &globals->t3E1081;
			return eax_43;
		}
	}
	eax_43 = eax_21;
	return eax_43;
}

// 003E1122: Register byte fn003E1122(Stack Eq_9 dwArg04)
byte fn003E1122(Eq_9 dwArg04)
{
	return (byte) (-(dwArg04 & 0x80000000) == 0x00);
}

// 003E1136: void fn003E1136(Register ptr32 ebp, Stack (ptr Eq_3) dwArg04, Stack Eq_9 dwArg08)
void fn003E1136(ptr32 ebp, Eq_3 * dwArg04, Eq_9 dwArg08)
{
	globals->t3E8818 = GetModuleHandleA(0x00);
	globals->t3E881C = dwArg08;
	ptr32 esp_216 = fp - 44;
	word32 dwLoc08_219 = dwArg08 + Mem21[dwArg04 + 0x80:word32];
	while (true)
	{
		union Eq_9 * esp_61 = esp_216 - 0x04;
		*esp_61 = (union Eq_9 *) dwLoc08_219;
		if (*((char *) *esp_61 + 0x0C) == 0x00)
			break;
		Eq_9 dwLoc10_118;
		*esp_61 = (union Eq_9 *) dwLoc08_219;
		Eq_9 eax_76 = *esp_61;
		*esp_61 = (union Eq_9 *) dwArg08;
		word32 ecx_83 = Mem80[esp_61 + 0x00:word32] + Mem80[eax_76 + 0x0C:word32];
		*esp_61 = (union Eq_9 *) ecx_83;
		Eq_9 eax_88 = LoadLibraryA(*esp_61);
		if (*((word32) dwLoc08_219 + 0x04) == 0x00)
		{
			*(esp_61 - 0x04) = (union Eq_9 *) dwArg08;
			dwLoc10_118 = (word32) *((word32) dwLoc08_219 + 0x0010) + *(esp_61 - 0x04);
		}
		else
		{
			*(esp_61 - 0x04) = (union Eq_9 *) dwArg08;
			dwLoc10_118 = (word32) *dwLoc08_219 + *(esp_61 - 0x04);
		}
		*(esp_61 - 0x04) = (union Eq_9 *) dwLoc08_219;
		struct Eq_165 * eax_98 = *(esp_61 - 0x04);
		*(esp_61 - 0x04) = (union Eq_9 *) dwArg08;
		union Eq_9 * esp_104 = esp_61;
		word32 * dwLoc18_107 = *(esp_61 - 0x04) + eax_98->dw0010;
		while (*dwLoc10_118 != 0x00)
		{
			ptr32 esp_149;
			Eq_28 dwLoc14_148;
			union Eq_9 * esp_123 = esp_104 - 0x04;
			*esp_123 = (union Eq_9 *) eax_88;
			*(esp_123 - 0x04) = (union Eq_9 *) dwLoc10_118;
			*(esp_123 - 0x04) = **(esp_123 - 0x04);
			if ((word32) fn003E1122(dwArg00) != 0x00)
			{
				*esp_123 = (union Eq_9 *) dwLoc10_118;
				*esp_123 = **esp_123;
				*esp_123 = (union Eq_9 *) (word32) (word16) (*esp_123 & 0xFFFF);
				*(esp_123 - 0x04) = (union Eq_9 *) eax_88;
				esp_149 = esp_123 - 0x04;
				dwLoc14_148 = GetProcAddress(*(esp_123 - 0x04), *esp_123);
			}
			else
			{
				*esp_123 = (union Eq_9 *) dwLoc10_118;
				Mem201[esp_123 + 0x00:word32] = dwArg08 + Mem189[Mem189[esp_123 + 0x00:word32] + 0x00:word32] + 0x02;
				*(esp_123 - 0x04) = (union Eq_9 *) ecx_83;
				*(esp_123 - 0x08) = (union Eq_9 *) eax_88;
				esp_149 = (char *) esp_123 + 0x04;
				dwLoc14_148 = fn003E10B0(dwArg00, dwArg04, dwArg08);
			}
			*dwLoc18_107 = (word32) dwLoc14_148;
			union Eq_9 * esp_157 = esp_149 - 0x04;
			*esp_157 = (union Eq_9 *) dwLoc10_118;
			dwLoc18_107 = dwLoc18_107 + 0x01;
			esp_104 = (union Eq_9 *) ((char *) esp_157 + 0x04);
			dwLoc10_118 = (char *) *esp_157 + 0x04;
		}
		union Eq_9 * esp_213 = esp_104 - 0x04;
		*esp_213 = (union Eq_9 *) dwLoc08_219;
		esp_216 = (char *) esp_213 + 0x04;
		dwLoc08_219 = (char *) *esp_213 + 0x0014;
	}
}

// 003E1270: void fn003E1270(Register ui32 ecx, Stack word32 dwArg04, Stack word32 dwArg08, Stack word32 dwArg0C)
void fn003E1270(ui32 ecx, word32 dwArg04, word32 dwArg08, word32 dwArg0C)
{
}

// 003E12A6: void fn003E12A6(Register ui32 ecx, Stack word32 dwArg04, Stack word32 dwArg08, Stack ui32 dwArg0C)
void fn003E12A6(ui32 ecx, word32 dwArg04, word32 dwArg08, ui32 dwArg0C)
{
	ptr32 esp_10 = fp - 0x08;
	do
	{
		LPOVERLAPPED * esp_20 = esp_10 - 0x04;
		*esp_20 = (LPOVERLAPPED *) null;
		*(esp_20 - 0x04) = fp - 0x08;
		*(esp_20 - 0x08) = dwArg0C;
		*(esp_20 - 0x08) = *(esp_20 - 0x08) - (ecx & 0x00);
		*(esp_20 - 0x0C) = dwArg08;
		*(esp_20 - 0x10) = dwArg04;
		esp_10 = esp_20 - 0x10;
	} while (WriteFile(*(esp_20 - 0x10), *(esp_20 - 0x0C), *(esp_20 - 0x08), *(esp_20 - 0x04), *esp_20) != 0x00 && (ecx & 0x00) != dwArg0C);
}

// 003E12DC: void fn003E12DC(Register ui32 ecx, Stack (ptr Eq_504) dwArg04, Stack ui32 dwArg08, Stack uint32 dwArg0C)
void fn003E12DC(ui32 ecx, Eq_504 * dwArg04, ui32 dwArg08, uint32 dwArg0C)
{
	uint32 dwLoc08_10 = ecx & 0x00;
	while (dwLoc08_10 < dwArg0C)
	{
		fn003E12A6(dwArg08, dwArg04->dw0004, dwArg08 + dwLoc08_10 * 0x04, 0x08);
		fn003E1270(dwArg08, dwArg04->dw0000, dwArg08 + dwLoc08_10 * 0x04, 0x08);
		dwLoc08_10 = dwLoc08_10 + 0x02;
	}
}

// 003E141E: Register Eq_389 fn003E141E(Stack (ptr Eq_3) dwArg04)
HANDLE fn003E141E(Eq_3 * dwArg04)
{
	CloseHandle(dwArg04->b0000);
	Eq_389 v8_22 = dwArg04[0x04];
	CloseHandle(v8_22);
	return v8_22;
}

// 003E143B: Register word32 fn003E143B(Register ui32 ecx, Register ptr32 ebp)
word32 fn003E143B(ui32 ecx, ptr32 ebp)
{
	if ((word32) fn003E15D0()->ptr0030->b0002 == 0x00)
	{
		globals->dw40FC7D = 17757;
		globals->dw40FC81 = 14108;
		globals->dw40FC85 = 22572;
		globals->dw40FC89 = 0x20CD;
		globals->dw40FC89 = globals->dw40FC89 + 19255;
		if (CreatePipe(fp - 0x24, fp - 0x14, null, 0x10) != 0x00 && CreatePipe(fp - 0x18, fp - 0x20, null, 0x10) != 0x00)
		{
			CreateThread(null, 0x00, &globals->t3E1330, fp - 0x24, 0x00, fp - 0x0C);
			fn003E12DC(ecx, fp - 0x18, 0x003E3000, globals->dw3E8803 >> 0x02);
			*(fp - 0x70) = fn003E141E(fp - 0x18) - 0x20;
			ptr32 ebp_150 = fn003E141E(dwArg00);
			*(fp - 0x70) = *(ebp_150 - 0x24);
			CloseHandle(*(fp - 0x70));
			*(fp - 116) = 0x003E3000;
			*(ebp_150 - 0x0C) = fn003E1000(dwArg00);
			if (*(ebp_150 - 0x0C) != 0x00)
			{
				*(fp - 116) = *(ebp_150 - 0x0C);
				*(ebp_150 - 44) = *((char *) *(fp - 116) + 0x0034);
				*(fp - 116) = *((char *) *(ebp_150 - 0x0C) + 0x0054);
				*(fp - 0x78) = *(ebp_150 - 44);
				*(fp - 0x7C) = 0x003E3000;
				fn003E101F(dwArg00, dwArg04, dwArg08);
				*(fp - 116) = *(ebp_150 - 44);
				*(fp - 0x78) = 0x003E3000;
				*(fp - 0x7C) = *(ebp_150 - 0x0C);
				fn003E15E0(dwArg00, dwArg04, dwArg08);
				*(fp - 116) = *(ebp_150 - 44);
				*(ebp_150 - 0x28) = fn003E1000(dwArg00);
				if (*(ebp_150 - 0x28) != 0x00)
				{
					*(fp - 116) = *(ebp_150 - 44);
					*(fp - 0x78) = *(ebp_150 - 0x28);
					fn003E1136(ebp_150, dwArg00, dwArg04);
					*(fp - 116) = *(ebp_150 - 44);
					*(fp - 0x78) = *(ebp_150 - 0x28);
					fn003E1776(ebp_150, dwArg00, dwArg04);
					struct Eq_848 * eax_232 = *(ebp_150 - 0x18);
					*(fp - 116) = *(ebp_150 - 44);
					eax_232->dw0008 = *(fp - 116);
					struct Eq_871 * eax_239 = *(ebp_150 - 0x0C);
					*(fp - 116) = *(ebp_150 - 44);
					word32 ecx_245 = *(fp - 116) + eax_239->dw0028;
					*(ebp_150 - 0x30) = ecx_245;
					word32 esp_248;
					word32 ebp_249;
					byte SCZO_250;
					word32 eax_251;
					byte SZO_252;
					byte C_253;
					byte Z_254;
					word32 ecx_255;
					(*(ebp_150 - 0x30))();
				}
			}
		}
	}
	return 0x00;
}

// 003E15B5: Register Eq_21 Win32CrtStartup()
DWORD Win32CrtStartup()
{
	*(fp - 0x08) = fn003E143B(ecx, fp - 0x04);
	*(fp - 0x0C) = *(fp - 0x08);
	ExitProcess(*(fp - 0x0C));
}

// 003E15D0: Register word32 fn003E15D0()
word32 fn003E15D0()
{
	return fs->dw0018;
}

// 003E15E0: void fn003E15E0(Stack (ptr Eq_3) dwArg04, Stack Eq_9 dwArg08, Stack Eq_10 dwArg0C)
void fn003E15E0(Eq_3 * dwArg04, Eq_9 dwArg08, SIZE_T dwArg0C)
{
	word16 ax_21 = dwArg04[0x06];
	cui16 wLoc14_130 = wLoc14 & 0x00;
	while ((word32) wLoc14_130 < (word32) ax_21)
	{
		Eq_10 dwLoc2C_132;
		Eq_10 eax_64 = (dwArg04 + 0x00F8)[(word32) wLoc14_130 *s 0x28 + 0x08];
		Eq_10 v16_73 = (dwArg04 + 0x00F8)[(word32) wLoc14_130 *s 0x28 + 0x10];
		if (eax_64 < v16_73)
			dwLoc2C_132 = eax_64;
		else
			dwLoc2C_132 = v16_73;
		fn003E1942(dwArg0C + Mem0[((word32) wLoc14_130 *s 0x28 + 0x0C) + (dwArg04 + 0xF8):word32], dwArg08 + Mem0[((word32) wLoc14_130 *s 0x28 + 0x14) + (dwArg04 + 0xF8):word32], dwLoc2C_132);
		wLoc14_130 = wLoc14_130 + 0x01;
	}
}

// 003E16AB: Register ui32 fn003E16AB(Register int32 ecx, Stack ui32 dwArg04)
ui32 fn003E16AB(int32 ecx, ui32 dwArg04)
{
	ui32 dwLoc08_10 = ecx & 0x00;
	if ((dwArg04 & 0x04000000) != 0x00)
		dwLoc08_10 = ecx & 0x00 | 0x0200;
	ui32 dwLoc08_117;
	if ((dwArg04 & 0x20000000) != 0x00)
	{
		if ((dwArg04 & 0x40000000) != 0x00)
		{
			if ((dwArg04 & 0x80000000) != 0x00)
				dwLoc08_117 = dwLoc08_10 | 0x40;
			else
				dwLoc08_117 = dwLoc08_10 | 0x20;
		}
		else if ((dwArg04 & 0x80000000) != 0x00)
			dwLoc08_117 = dwLoc08_10 | 0x80;
		else
			dwLoc08_117 = dwLoc08_10 | 0x10;
	}
	else if ((dwArg04 & 0x40000000) != 0x00)
	{
		if ((dwArg04 & 0x80000000) != 0x00)
			dwLoc08_117 = dwLoc08_10 | 0x04;
		else
			dwLoc08_117 = dwLoc08_10 | 0x02;
	}
	else if ((dwArg04 & 0x80000000) != 0x00)
		dwLoc08_117 = dwLoc08_10 | 0x08;
	else
		dwLoc08_117 = dwLoc08_10 | 0x01;
	return dwLoc08_117;
}

// 003E1776: void fn003E1776(Register ptr32 ebp, Stack (ptr Eq_3) dwArg04, Stack Eq_9 dwArg08)
void fn003E1776(ptr32 ebp, Eq_3 * dwArg04, Eq_9 dwArg08)
{
	word16 ax_21 = dwArg04[0x06];
	ptr32 esp_27 = fp - 0x20;
	cui16 wLoc14_101 = wLoc14 & 0x00;
	while ((word32) wLoc14_101 < (word32) ax_21)
	{
		union Eq_9 * esp_50 = esp_27 - 0x04;
		*esp_50 = (union Eq_9 *) (dwArg04 + 0x00F8);
		Eq_9 ecx_52 = *esp_50;
		*esp_50 = (union Eq_9 *) dwArg08;
		word32 edx_60 = Mem57[esp_50 + 0x00:word32] + Mem57[((word32) wLoc14_101 *s 0x28 + 0x0C) + ecx_52:word32];
		*esp_50 = (union Eq_9 *) (dwArg04 + 0x00F8)[(word32) wLoc14_101 *s 0x28 + 0x08];
		Eq_9 eax_68 = *esp_50;
		*esp_50 = (union Eq_9 *) (fp - 0x18);
		*(esp_50 - 0x04) = dwArg04 + 0x00F8;
		int32 ecx_80 = *(esp_50 - 0x04);
		*(esp_50 - 0x04) = (word32) ((word32) wLoc14_101 *s 0x28) + 0x0024 + ecx_80;
		*(esp_50 - 0x04) = fn003E16AB(ecx_80, dwArg00);
		*(esp_50 - 0x08) = (union Eq_9 *) eax_68;
		*(esp_50 - 0x0C) = (LPVOID *) edx_60;
		VirtualProtect(*(esp_50 - 0x0C), *(esp_50 - 0x08), *(esp_50 - 0x04), *esp_50);
		esp_27 = esp_50 - 0x0C;
		wLoc14_101 = wLoc14_101 + 0x01;
	}
}

// 003E1810: Register int32 fn003E1810(Stack int32 dwArg04)
int32 fn003E1810(int32 dwArg04)
{
	int32 eax_12;
	if (dwArg04 >= 0x41 && dwArg04 <= 0x5A)
		eax_12 = dwArg04 + 0x20;
	else
		eax_12 = dwArg04;
	return eax_12;
}

// 003E1942: void fn003E1942(Stack Eq_9 dwArg04, Stack (ptr Eq_3) dwArg08, Stack Eq_10 dwArg0C)
void fn003E1942(Eq_9 dwArg04, Eq_3 * dwArg08, SIZE_T dwArg0C)
{
	while (true)
	{
		dwArg0C = dwArg0C - 0x01;
		if (dwArg0C == 0x00)
			break;
		*dwArg04 = dwArg08->b0000;
		dwArg04 = (word32) dwArg04 + 0x01;
		dwArg08 = dwArg08 + 0x01;
	}
}

// 003E19AF: Register int32 fn003E19AF(Register word32 ecx, Stack Eq_9 dwArg04, Stack (ptr byte) dwArg08)
int32 fn003E19AF(word32 ecx, Eq_9 dwArg04, byte * dwArg08)
{
	while (true)
	{
		int32 eax_31 = (word32) *dwArg04 - (word32) (*dwArg08);
		int32 dwLoc08_34 = eax_31;
		if (eax_31 != 0x00 || (int32) (*dwArg08) == 0x00)
			break;
		dwArg04 = (word32) dwArg04 + 0x01;
		dwArg08 = dwArg08 + 0x01;
	}
	if (eax_31 < 0x00)
		dwLoc08_34 = eax_31 | ~0x00;
	else if (eax_31 > 0x00)
		dwLoc08_34 = 0x01;
	return dwLoc08_34;
}

// 003E1A30: Register word32 fn003E1A30(Stack (ptr Eq_3) dwArg04, Stack (ptr byte) dwArg08)
word32 fn003E1A30(Eq_3 * dwArg04, byte * dwArg08)
{
	do
	{
		word32 eax_19 = fn003E1810((word32) dwArg04->b0000);
		dwArg04 = dwArg04 + 0x01;
		word32 eax_41 = fn003E1810((word32) *dwArg08);
		dwArg08 = dwArg08 + 0x01;
	} while (eax_19 != 0x00 && eax_19 == eax_41);
	return eax_19 - eax_41;
}

